document.addEventListener('DOMContentLoaded', () => {
    // --- CONFIGURACIÓN INICIAL ---
    const synth = new Tone.PolySynth(Tone.Synth).toDestination();
    const svg = document.getElementById('circle-svg');
    const shapePolygon = document.getElementById('shape-polygon');
    const selectedNotesDiv = document.getElementById('selected-notes');
    const shapeSelector = document.getElementById('shape-selector');
    const rotateLeftBtn = document.getElementById('rotate-left');
    const rotateRightBtn = document.getElementById('rotate-right');
    const playButton = document.getElementById('play-button');

    const notesInCircle = [ // Ordenado por círculo de quintas
        { name: 'C', scientific: 'C4' }, { name: 'G', scientific: 'G4' },
        { name: 'D', scientific: 'D4' }, { name: 'A', scientific: 'A4' },
        { name: 'E', scientific: 'E4' }, { name: 'B', scientific: 'B4' },
        { name: 'F#', scientific: 'F#4' }, { name: 'C#', scientific: 'C#4' },
        { name: 'G#', scientific: 'G#4' }, { name: 'D#', scientific: 'D#4' },
        { name: 'A#', scientific: 'A#4' }, { name: 'F', scientific: 'F4' }
    ];

    const shapes = {
        '3': { name: 'Triángulo (Acorde Aumentado)' },
        '4': { name: 'Cuadrado (Acorde Disminuido 7)' },
        '5': { name: 'Pentágono (Escala Pentatónica)' },
        '6': { name: 'Hexágono (Escala Tonos Enteros)' },
        '7': { name: 'Heptágono (Escala Mayor/Menor)' }
    };

    const centerX = 200, centerY = 200, radius = 170, noteRadius = 30;
    let currentRotation = 0; // en pasos de nota (0-11)
    let numVertices = 3; // Empezar con un triángulo

    // --- FUNCIONES DE DIBUJO Y LÓGICA ---

    // Agregamos un bucle para generar las opciones del selector dinámicamente.
    // Esto hace que el código sea más escalable si quieres añadir más formas.
    function setupShapeSelector() {
        for (const vertices in shapes) {
            const option = document.createElement('option');
            option.value = vertices;
            option.textContent = shapes[vertices].name;
            shapeSelector.appendChild(option);
        }
    }

    function drawCircle() {
        // ... (Tu función drawCircle es perfecta, no necesita cambios)
        notesInCircle.forEach((note, i) => {
            const angle = (i / 12) * 2 * Math.PI - (Math.PI / 2);
            const x = centerX + radius * Math.cos(angle);
            const y = centerY + radius * Math.sin(angle);

            const circle = document.createElementNS("http://www.w3.org/2000/svg", "circle");
            circle.setAttribute('id', `note-bg-${i}`);
            circle.setAttribute('class', 'note-circle');
            circle.setAttribute('cx', x);
            circle.setAttribute('cy', y);
            circle.setAttribute('r', noteRadius);
            svg.appendChild(circle);

            const text = document.createElementNS("http://www.w3.org/2000/svg", "text");
            text.setAttribute('class', 'note-text');
            text.setAttribute('x', x);
            text.setAttribute('y', y);
            text.textContent = note.name;
            svg.appendChild(text);
        });
        svg.appendChild(shapePolygon);
    }

    function updateSelectionAndShape() {
        const points = [];
        const selectedNotes = [];
        
        // Limpiar selección previa
        document.querySelectorAll('.note-circle.active').forEach(c => c.classList.remove('active'));

        for (let i = 0; i < numVertices; i++) {
            const step = 12 / numVertices;
            const noteIndex = Math.round((currentRotation + i * step) % 12);
            
            // Asegurarse de que el índice sea válido
            if (notesInCircle[noteIndex]) {
                selectedNotes.push(notesInCircle[noteIndex]);

                // Resaltar círculo de nota
                document.getElementById(`note-bg-${noteIndex}`).classList.add('active');
                
                // Calcular puntos para el polígono
                const angle = (noteIndex / 12) * 2 * Math.PI - (Math.PI / 2);
                const x = centerX + radius * Math.cos(angle);
                const y = centerY + radius * Math.sin(angle);
                points.push(`${x},${y}`);
            }
        }
        
        shapePolygon.setAttribute('points', points.join(' '));
        selectedNotesDiv.textContent = selectedNotes.map(n => n.name).join(' - ');

        return selectedNotes.map(n => n.scientific);
    }

    // --- EVENT LISTENERS ---
    shapeSelector.addEventListener('change', (e) => {
        numVertices = parseInt(e.target.value, 10);
        updateSelectionAndShape();
    });

    rotateLeftBtn.addEventListener('click', () => {
        currentRotation = (currentRotation - 1 + 12) % 12;
        updateSelectionAndShape();
    });

    rotateRightBtn.addEventListener('click', () => {
        currentRotation = (currentRotation + 1) % 12;
        updateSelectionAndShape();
    });

    playButton.addEventListener('click', async () => {
        await Tone.start();
        const notesToPlay = updateSelectionAndShape();

        // Toca las notas secuencialmente con un intervalo.
        const sequence = new Tone.Sequence((time, note) => {
            // Resalta la nota actual en el círculo mientras se reproduce.
            const noteIndex = notesInCircle.findIndex(n => n.scientific === note);
            document.querySelectorAll('.note-circle').forEach(c => c.classList.remove('active'));
            if (document.getElementById(`note-bg-${noteIndex}`)) {
                document.getElementById(`note-bg-${noteIndex}`).classList.add('active');
            }
            synth.triggerAttackRelease(note, "8n", time);
        }, notesToPlay).start(0);

        Tone.Transport.start();

        // Detener la secuencia y limpiar las notas resaltadas después de 2 segundos.
        setTimeout(() => {
            sequence.stop();
            Tone.Transport.stop();
            document.querySelectorAll('.note-circle').forEach(c => c.classList.remove('active'));
            // Vuelve a resaltar las notas de la forma al final de la reproducción.
            updateSelectionAndShape(); 
        }, notesToPlay.length * 500); // 500 ms por nota
    });

    // --- INICIALIZACIÓN ---
    drawCircle();
    setupShapeSelector(); // Llamar a la función para generar las opciones
    updateSelectionAndShape();
});
