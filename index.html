<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Motor Sónico Geométrico V3</title>
<script src="https://cdn.jsdelivr.net/npm/tone@14.8.41/build/Tone.js"></script>
<style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400&display=swap');
    :root {
        --glow-color: #a29bfe;
        --bg-color: #0d1117;
        --ui-bg: #161b22;
        --border-color: #30363d;
        --text-primary: #c9d1d9;
        --text-secondary: #8b949e;
    }
    html, body {
        height: 100%;
        margin: 0;
        overflow: hidden;
    }
    body {
        display: flex;
        justify-content: center;
        align-items: center;
        background: radial-gradient(ellipse at bottom, #1b2735 0%, #090a0f 100%);
        font-family: 'Inter', sans-serif;
        color: var(--text-primary);
    }
    #main-container {
        display: flex;
        flex-direction: column;
        gap: 20px;
        padding: 20px;
        width: 100%;
        height: 100%;
        max-width: 1200px;
        box-sizing: border-box;
    }
    .header { text-align: center; }
    .header h1 { margin: 0; font-weight: 400; }
    .header p { margin: 5px 0 0 0; color: var(--text-secondary); }
    
    .content-body {
        display: flex;
        flex-grow: 1;
        gap: 20px;
        min-height: 0;
    }
    #svg-container {
        flex-grow: 1;
        display: flex;
        justify-content: center;
        align-items: center;
        min-width: 0;
    }
    svg {
        width: 100%;
        max-width: 500px;
        height: auto;
        aspect-ratio: 1 / 1;
        animation: cosmic-rotation 240s linear infinite;
    }
    @keyframes cosmic-rotation { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

    #controls {
        display: flex;
        flex-direction: column;
        gap: 15px;
        background: var(--ui-bg);
        border: 1px solid var(--border-color);
        border-radius: 10px;
        padding: 20px;
        width: 300px;
        flex-shrink: 0;
        overflow-y: auto;
    }

    /* --- ESTILOS VISUALIZADOR --- */
    .circle-point { fill: #444; transition: all 0.1s ease-in-out; }
    .circle-point.active { fill: var(--glow-color); r: 11; filter: drop-shadow(0 0 8px var(--glow-color)); }
    line { stroke: var(--glow-color); stroke-width: 1.5; opacity: 0; transition: all 0.2s ease-in-out; }
    line.visible { opacity: 0.25; }
    line.active { opacity: 1; stroke: #fff; }
    #note-label {
        font-size: 22px; fill: #fff; text-anchor: middle; dominant-baseline: middle;
        pointer-events: none; opacity: 0; transition: opacity 0.2s;
    }
    #note-label.visible { opacity: 1; }
    
    /* --- ESTILOS CONTROLES --- */
    .control-group { display: flex; flex-direction: column; gap: 8px; }
    label { font-size: 0.8em; text-transform: uppercase; letter-spacing: 0.5px; color: var(--text-secondary); }
    button, select, input {
        background: #0d1117; color: var(--text-primary); border: 1px solid var(--border-color);
        border-radius: 6px; padding: 8px 12px; font-size: 0.9em; width: 100%; box-sizing: border-box;
    }
    select, button { cursor: pointer; }
    button:hover, select:hover { border-color: var(--glow-color); }
    #play { font-weight: bold; padding: 12px; }
    #play.playing { background: #d63031; border-color: #d63031; }
    .bpm-control, .octave-control { display: flex; align-items: center; gap: 10px; }
    #bpm-value { font-variant-numeric: tabular-nums; }
    .octave-control button { width: 40px; }
    .octave-control span { flex-grow: 1; text-align: center; }

    /* --- DISEÑO ADAPTABLE (RESPONSIVE) --- */
    @media (max-width: 768px) {
        body { overflow: auto; }
        #main-container { flex-direction: column; height: auto; }
        .content-body { flex-direction: column; }
        #controls { width: 100%; max-height: none; }
        svg { max-width: 90vw; }
    }
</style>
</head>
<body>

<div id="main-container">
    <header class="header">
        <h1>Motor Sónico Geométrico</h1>
        <p id="init-message">Haz clic en Iniciar para activar el audio</p>
    </header>

    <div class="content-body">
        <div id="svg-container">
            <svg id="circle-svg" viewBox="0 0 400 400">
                <g id="lines-group"></g>
                <g id="points-group"></g>
                <text id="note-label" x="-100" y="-100"></text>
            </svg>
        </div>
        <div id="controls">
            <div class="control-group">
                <button id="play">▶ Iniciar</button>
            </div>
            <div class="control-group">
                <label for="shape-select">Forma Geométrica</label>
                <select id="shape-select">
                    <option value="circle">Círculo (12)</option>
                    <option value="aug">Triángulo Aum. (3)</option>
                    <option value="dim">Cuadrado Dis. (4)</option>
                    <option value="penta">Pentágono (5)</option>
                    <option value="hexa">Hexágono (6)</option>
                    <option value="hepta">Heptágono (7)</option>
                    <option value="octa">Octágono (8)</option>
                    <option value="star7">Heptagrama</option>
                    <option value="star5">Pentagrama</option>
                </select>
            </div>
            <div class="control-group">
                <label for="mode-select">Modo de Sonido</label>
                <select id="mode-select">
                    <option value="melody">Melodía</option>
                    <option value="arpeggio">Arpegio</option>
                    <option value="triad">Acorde (Triada)</option>
                    <option value="seventh">Acorde (Séptima)</option>
                </select>
            </div>
            <div class="control-group">
                <label for="sound-palette-select">Paleta Sonora</label>
                <select id="sound-palette-select">
                    <option value="celestial">Celestial</option>
                    <option value="psychedelic">Psicodélico</option>
                    <option value="mystic">Místico</option>
                </select>
            </div>
            <div class="control-group">
                <label for="scale-select">Escala Musical</label>
                <select id="scale-select">
                    <option value="major">Mayor</option>
                    <option value="minor">Menor</option>
                    <option value="dorian">Dórico</option>
                    <option value="phrygian">Frigio</option>
                    <option value="lydian">Lidio</option>
                    <option value="pentatonic">Pentatónica</option>
                    <option value="wholetone">Tono Entero</option>
                </select>
            </div>
            <div class="control-group">
                <label>Octava</label>
                <div class="octave-control">
                   <button id="octave-down">-</button>
                   <span id="octave-value">4</span>
                   <button id="octave-up">+</button>
                </div>
           </div>
            <div class="control-group">
                <label for="bpm-slider">Tempo</label>
                <div class="bpm-control">
                    <input type="range" id="bpm-slider" min="40" max="200" value="90">
                    <span id="bpm-value">90</span>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// --- FUNCIÓN DE UTILIDAD: DEBOUNCE ---
// Evita que una función se ejecute demasiadas veces seguidas.
function debounce(func, delay) {
    let timeout;
    return function(...args) {
        const context = this;
        clearTimeout(timeout);
        timeout = setTimeout(() => func.apply(context, args), delay);
    };
}

document.addEventListener('DOMContentLoaded', () => {

    const App = {
        state: {
            isPlaying: false, octave: 4, bpm: 90, shape: 'circle', mode: 'melody', sound: 'celestial', scale: 'major',
        },
        dom: {},
        svg: {
            centerX: 200, centerY: 200, radius: 170, numPoints: 12, points: [], lines: new Map(), activeShapeIndices: []
        },
        audio: {
            synths: {}, activeSynth: null, sequence: null, isInitialized: false,
            CIRCLE_OF_FIFTHS: ['C', 'G', 'D', 'A', 'E', 'B', 'F#', 'Db', 'Ab', 'Eb', 'Bb', 'F'],
            SCALES: {
                major: [0, 2, 4, 5, 7, 9, 11], minor: [0, 2, 3, 5, 7, 8, 10], dorian: [0, 2, 3, 5, 7, 9, 10],
                phrygian: [0, 1, 3, 5, 7, 8, 10], lydian: [0, 2, 4, 6, 7, 9, 11], pentatonic: [0, 2, 4, 7, 9],
                wholetone: [0, 2, 4, 6, 8, 10]
            },
            // Puntos predefinidos para cada forma para evitar errores de cálculo.
            SHAPES: {
                circle: [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11],
                aug: [0, 4, 8],
                dim: [0, 3, 6, 9],
                penta: [0, 2, 5, 7, 10],
                hexa: [0, 2, 4, 6, 8, 10],
                hepta: [0, 2, 4, 5, 7, 9, 11], // Heptatónica
                octa: [0, 2, 3, 5, 6, 8, 9, 11], // Octatónica
                star7: [0, 5, 10, 3, 8, 1, 6], // Heptagrama {7/2} en 12TET
                star5: [0, 4, 8, 1, 5, 9, 2, 6, 10, 3, 7, 11] // Estrella dodecagonal
            }
        },

        init() {
            this.cacheDom();
            this.initSVG();
            this.initAudio();
            this.bindEvents();
            this.updateShape();
            this.updateUI();
        },

        cacheDom() {
            this.dom = {
                svg: document.getElementById('circle-svg'),
                linesGroup: document.getElementById('lines-group'),
                pointsGroup: document.getElementById('points-group'),
                noteLabel: document.getElementById('note-label'),
                playBtn: document.getElementById('play'),
                shapeSelect: document.getElementById('shape-select'),
                modeSelect: document.getElementById('mode-select'),
                soundSelect: document.getElementById('sound-palette-select'),
                scaleSelect: document.getElementById('scale-select'),
                octaveUp: document.getElementById('octave-up'),
                octaveDown: document.getElementById('octave-down'),
                octaveValue: document.getElementById('octave-value'),
                bpmSlider: document.getElementById('bpm-slider'),
                bpmValue: document.getElementById('bpm-value'),
                initMessage: document.getElementById('init-message')
            };
        },
        
        initSVG() { /* (Sin cambios, es robusto) */
            for (let i = 0; i < this.svg.numPoints; i++) {
                const angle = (i / this.svg.numPoints) * 2 * Math.PI - Math.PI / 2;
                const x = this.svg.centerX + this.svg.radius * Math.cos(angle);
                const y = this.svg.centerY + this.svg.radius * Math.sin(angle);
                const circle = document.createElementNS("http://www.w3.org/2000/svg", "circle");
                circle.setAttribute('cx', x); circle.setAttribute('cy', y);
                circle.setAttribute('r', 8); circle.setAttribute('class', 'circle-point');
                this.dom.pointsGroup.appendChild(circle);
                this.svg.points.push({ x, y, el: circle, note: this.audio.CIRCLE_OF_FIFTHS[i] });
            }
            for (let i = 0; i < this.svg.numPoints; i++) {
                for (let j = i + 1; j < this.svg.numPoints; j++) {
                    const line = document.createElementNS("http://www.w3.org/2000/svg", "line");
                    line.setAttribute('x1', this.svg.points[i].x); line.setAttribute('y1', this.svg.points[i].y);
                    line.setAttribute('x2', this.svg.points[j].x); line.setAttribute('y2', this.svg.points[j].y);
                    this.dom.linesGroup.appendChild(line);
                    this.svg.lines.set(`${i}-${j}`, line);
                }
            }
        },

        initAudio() { /* (Sin cambios, es robusto) */
            const reverb = new Tone.Reverb({ decay: 6, wet: 0.5 }).toDestination();
            this.audio.synths.celestial = new Tone.PolySynth(Tone.FMSynth).connect(new Tone.FeedbackDelay("8n", 0.4).connect(reverb));
            const phaser = new Tone.Phaser({ frequency: 0.5, octaves: 3, baseFrequency: 350 });
            this.audio.synths.psychedelic = new Tone.PolySynth(Tone.AMSynth).connect(phaser).connect(new Tone.PingPongDelay("4n.", 0.3).connect(reverb));
            this.audio.synths.mystic = new Tone.PolySynth(Tone.DuoSynth).connect(new Tone.Chorus(4, 2.5, 0.5)).connect(reverb);
            this.audio.activeSynth = this.audio.synths[this.state.sound];
            Tone.Transport.bpm.value = this.state.bpm;
        },

        bindEvents() {
            this.dom.playBtn.addEventListener('click', () => this.togglePlayback());
            
            // Usamos 'input' para cambios en tiempo real, no 'change'
            this.dom.shapeSelect.addEventListener('input', e => this.updateState({ shape: e.target.value }));
            this.dom.modeSelect.addEventListener('input', e => this.updateState({ mode: e.target.value }));
            this.dom.soundSelect.addEventListener('input', e => this.updateState({ sound: e.target.value }));
            this.dom.scaleSelect.addEventListener('input', e => this.updateState({ scale: e.target.value }));

            this.dom.octaveUp.addEventListener('click', () => this.updateState({ octave: Math.min(6, this.state.octave + 1) }));
            this.dom.octaveDown.addEventListener('click', () => this.updateState({ octave: Math.max(1, this.state.octave - 1) }));

            // Aplicamos debounce al slider de BPM para mejorar rendimiento
            this.dom.bpmSlider.addEventListener('input', debounce(e => {
                this.updateState({ bpm: parseInt(e.target.value) });
            }, 50));
            // Actualización visual del BPM es instantánea
            this.dom.bpmSlider.addEventListener('input', e => {
                this.dom.bpmValue.textContent = e.target.value;
            });
        },

        updateState(newState) {
            Object.assign(this.state, newState);

            if (newState.sound) this.audio.activeSynth = this.audio.synths[this.state.sound];
            if (newState.bpm) Tone.Transport.bpm.value = this.state.bpm;
            if (newState.shape) this.updateShape();
            
            if (this.state.isPlaying) this.restartSequence();
            
            this.updateUI();
        },

        updateUI() {
            this.dom.playBtn.textContent = this.state.isPlaying ? '■ Detener' : '▶ Iniciar';
            this.dom.playBtn.classList.toggle('playing', this.state.isPlaying);
            this.dom.octaveValue.textContent = this.state.octave;
            this.dom.bpmValue.textContent = this.state.bpm;
            this.dom.bpmSlider.value = this.state.bpm;
            
            const colors = { celestial: '#a29bfe', psychedelic: '#fd79a8', mystic: '#00cec9' };
            document.documentElement.style.setProperty('--glow-color', colors[this.state.sound]);
        },

        updateShape() {
            this.svg.activeShapeIndices = this.audio.SHAPES[this.state.shape] || [];
            this.svg.lines.forEach(line => line.classList.remove('visible'));
            
            const pointsToConnect = this.svg.activeShapeIndices;
            if (pointsToConnect.length < 2) return;

            for(let i = 0; i < pointsToConnect.length; i++) {
                const p1_idx = pointsToConnect[i];
                const p2_idx = pointsToConnect[(i + 1) % pointsToConnect.length];
                const key = [p1_idx, p2_idx].sort((a, b) => a - b).join('-');
                if(this.svg.lines.has(key)) this.svg.lines.get(key).classList.add('visible');
            }
        },

        async togglePlayback() {
            if (!this.audio.isInitialized) {
                await Tone.start();
                this.audio.isInitialized = true;
                this.dom.initMessage.style.display = 'none';
            }
            this.state.isPlaying = !this.state.isPlaying;
            if (this.state.isPlaying) {
                this.restartSequence();
                Tone.Transport.start();
            } else {
                Tone.Transport.stop();
                Tone.Transport.cancel(); // Limpia eventos agendados
                if(this.audio.sequence) this.audio.sequence.dispose();
                this.audio.activeSynth.releaseAll(); // Forza a que se callen las notas
                this.clearAllActiveVisuals();
            }
            this.updateUI();
        },

        restartSequence() {
            if (this.audio.sequence) this.audio.sequence.dispose();
            if (this.svg.activeShapeIndices.length === 0) return; // No hacer nada si la forma no tiene puntos

            this.audio.sequence = new Tone.Sequence((time, stepIndex) => {
                const pointIndex = this.svg.activeShapeIndices[stepIndex];
                const point = this.svg.points[pointIndex];
                const note = point.note + this.state.octave;
                const scaleIntervals = this.audio.SCALES[this.state.scale];

                // Lógica de generación de notas (refactorizada para claridad)
                try {
                    const baseFreq = Tone.Frequency(note);
                    switch (this.state.mode) {
                        case 'melody':
                            const randomNote = baseFreq.transpose(scaleIntervals[Math.floor(Math.random() * scaleIntervals.length)]).toNote();
                            this.audio.activeSynth.triggerAttackRelease(note, "8n", time);
                            this.audio.activeSynth.triggerAttackRelease(randomNote, "16n", time + Tone.Time("8n").toSeconds());
                            break;
                        case 'arpeggio':
                            const arpNotes = [note, baseFreq.transpose(scaleIntervals[2] || 4).toNote(), baseFreq.transpose(scaleIntervals[4] || 7).toNote()];
                             new Tone.Pattern((t, n) => this.audio.activeSynth.triggerAttackRelease(n, '16n', t), arpNotes).start(time).stop(time + 0.4);
                            break;
                        case 'triad':
                            const triadNotes = [note, baseFreq.transpose(scaleIntervals[2] || 4).toNote(), baseFreq.transpose(scaleIntervals[4] || 7).toNote()];
                            this.audio.activeSynth.triggerAttackRelease(triadNotes, "4n", time);
                            break;
                        case 'seventh':
                            const seventhNotes = [note, baseFreq.transpose(scaleIntervals[2] || 4).toNote(), baseFreq.transpose(scaleIntervals[4] || 7).toNote(), baseFreq.transpose(scaleIntervals[6] || 10).toNote()];
                            this.audio.activeSynth.triggerAttackRelease(seventhNotes, "4n", time);
                            break;
                    }
                } catch (error) {
                    console.error("Error al tocar la nota:", error);
                }

                Tone.Draw.schedule(() => this.visualizeStep(pointIndex, note), time);

            }, Array.from(Array(this.svg.activeShapeIndices.length).keys()), "4n").start(0);
        },

        visualizeStep(pointIndex, noteName) {
            this.clearAllActiveVisuals();
            const point = this.svg.points[pointIndex];
            point.el.classList.add('active');

            this.svg.lines.forEach((line, key) => {
                if (line.classList.contains('visible')) {
                    const [p1, p2] = key.split('-').map(Number);
                    if (p1 === pointIndex || p2 === pointIndex) line.classList.add('active');
                }
            });
            
            const labelOffset = 35, angle = (pointIndex / 12) * 2 * Math.PI - Math.PI / 2;
            const x = this.svg.centerX + (this.svg.radius + labelOffset) * Math.cos(angle);
            const y = this.svg.centerY + (this.svg.radius + labelOffset) * Math.sin(angle);
            this.dom.noteLabel.setAttribute('x', x); this.dom.noteLabel.setAttribute('y', y);
            this.dom.noteLabel.textContent = noteName;
            this.dom.noteLabel.classList.add('visible');
        },

        clearAllActiveVisuals() {
            this.svg.points.forEach(p => p.el.classList.remove('active'));
            this.svg.lines.forEach(line => line.classList.remove('active'));
            this.dom.noteLabel.classList.remove('visible');
        }
    };

    App.init();
});
</script>

</body>
</html>
